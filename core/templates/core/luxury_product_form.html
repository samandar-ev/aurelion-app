{% extends 'core/base.html' %}

{% block title %}Register Luxury Product - AURELION{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-11">
        <div class="d-flex align-items-center justify-content-between mb-4">
            <div class="d-flex align-items-center">
                <a href="{% url 'product_list' %}" class="text-decoration-none text-muted me-3">&larr; Back</a>
                <div>
                    <h2 class="mb-1">Register Luxury Product</h2>
                    <p class="text-muted small mb-0">Capture provenance, variants, packaging and compliance in one go.
                    </p>
                </div>
            </div>
        </div>

        <form method="post" enctype="multipart/form-data" id="luxuryProductForm" novalidate>
            {% csrf_token %}

            {% if form.non_field_errors %}
            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
            {% endif %}
            {% if variant_formset.non_form_errors %}
            <div class="alert alert-danger">{{ variant_formset.non_form_errors }}</div>
            {% endif %}

            <datalist id="brand-options">
                {% for brand in brand_suggestions %}
                <option value="{{ brand }}"></option>
                {% endfor %}
            </datalist>
            <datalist id="material-options">
                {% for material in material_choices %}
                <option value="{{ material }}"></option>
                {% endfor %}
            </datalist>
            <datalist id="color-suggestions">
                {% for color in color_suggestions %}
                <option value="{{ color }}"></option>
                {% endfor %}
            </datalist>

            
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">1. Product Identity</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="{{ form.brand.id_for_label }}" class="form-label">Brand <span
                                    class="text-danger">*</span></label>
                            {{ form.brand }}
                            {{ form.brand.errors }}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.name.id_for_label }}" class="form-label">Product Name <span
                                    class="text-danger">*</span></label>
                            {{ form.name }}
                            {{ form.name.errors }}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.category.id_for_label }}" class="form-label">Category <span
                                    class="text-danger">*</span></label>
                            {{ form.category }}
                            {{ form.category.errors }}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.collection.id_for_label }}" class="form-label">Collection / Line</label>
                            {{ form.collection }}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.season.id_for_label }}" class="form-label">Season</label>
                            {{ form.season }}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.description.id_for_label }}" class="form-label">Description (rich
                                text)</label>
                            {{ form.description }}
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">2. SKU & Codes</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="{{ form.base_sku.id_for_label }}" class="form-label">Internal SKU <span
                                    class="text-danger">*</span></label>
                            {{ form.base_sku }}
                            <small class="form-text text-muted">Auto-generated but editable.</small>
                            {{ form.base_sku.errors }}
                        </div>
                        {% if not form.supplier_product_code.is_hidden %}
                        <div class="col-md-4">
                            <label for="{{ form.supplier_product_code.id_for_label }}" class="form-label">Supplier
                                Product Code</label>
                            {{ form.supplier_product_code }}
                            {{ form.supplier_product_code.errors }}
                        </div>
                        {% else %}
                        {{ form.supplier_product_code }}
                        {% endif %}
                        <div class="col-md-4">
                            <label for="{{ form.release_year.id_for_label }}" class="form-label">Release Year</label>
                            {{ form.release_year }}
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">3. Luxury Attributes</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="{{ form.condition.id_for_label }}" class="form-label">Condition</label>
                            {{ form.condition }}
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="form-check mb-2">
                                {{ form.is_limited_edition }}
                                <label class="form-check-label" for="{{ form.is_limited_edition.id_for_label }}">
                                    Limited Edition
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">4. Variants, Pricing & Stock</h5>
                    <span class="small text-muted">Color, size, pricing, quantity per variant.</span>
                </div>
                <div class="card-body">
                    {{ variant_formset.management_form }}
                    <div id="variantFormset">
                        {% for variant_form in variant_formset.forms %}
                        <div class="card mb-3 variant-entry" data-index="{{ forloop.counter0 }}">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Variant {{ forloop.counter }}</strong>
                                    <span class="text-muted small ms-2">SKU (auto if blank), retail, quantity
                                        required.</span>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    {% if user.is_associate %}
                                    <span class="badge bg-light text-dark border">Cashier: pricing protected</span>
                                    {% endif %}
                                    {% if forloop.counter0 > 0 %}
                                    <button type="button" class="btn btn-sm btn-delete remove-variant">Remove</button>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="card-body">
                                {% if variant_form.non_field_errors %}
                                <div class="alert alert-danger small">{{ variant_form.non_field_errors }}</div>
                                {% endif %}
                                {{ variant_form.id }}{{ variant_form.DELETE.as_hidden }}
                                <div class="row g-3 mb-2">
                                    <div class="col-md-4">
                                        <label for="{{ variant_form.sku.id_for_label }}" class="form-label">Variant
                                            SKU</label>
                                        {{ variant_form.sku }}
                                        {{ variant_form.sku.errors }}
                                        <small class="text-muted">Auto-generated if left blank.</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ variant_form.color.id_for_label }}"
                                            class="form-label">Color</label>
                                        {{ variant_form.color }}
                                        {{ variant_form.color.errors }}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ variant_form.size.id_for_label }}"
                                            class="form-label">Size</label>
                                        {{ variant_form.size }}
                                        {{ variant_form.size.errors }}
                                    </div>
                                </div>
                                <div class="row g-3 mb-2">
                                    {% if variant_form.cost_price.is_hidden %}
                                    {{ variant_form.cost_price }}
                                    {% else %}
                                    <div class="col-md-3">
                                        <label for="{{ variant_form.cost_price.id_for_label }}" class="form-label">Cost
                                            Price</label>
                                        {{ variant_form.cost_price }}
                                    </div>
                                    {% endif %}
                                    <div class="col-md-3">
                                        <label for="{{ variant_form.retail_price.id_for_label }}"
                                            class="form-label">Retail Price <span class="text-danger">*</span></label>
                                        {{ variant_form.retail_price }}
                                        {{ variant_form.retail_price.errors }}
                                    </div>
                                    <div class="col-md-2">
                                        <label for="{{ variant_form.currency.id_for_label }}"
                                            class="form-label">Currency</label>
                                        {{ variant_form.currency }}
                                    </div>
                                    <div class="col-md-2">
                                        <label for="{{ variant_form.initial_quantity.id_for_label }}"
                                            class="form-label">Current Qty <span class="text-danger">*</span></label>
                                        {{ variant_form.initial_quantity }}
                                        {{ variant_form.initial_quantity.errors }}
                                    </div>
                                </div>
                                {{ variant_form.minimum_stock_level }}
                                {{ variant_form.barcode }}{{ variant_form.barcode_type }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-view" id="addVariantBtn">+ Add Variant</button>
                </div>
            </div>

            
            {% if not form.packaging_condition.is_hidden %}
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">5. Packaging & Accessories</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label d-block mb-2">Included Items</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <div class="form-check">
                                        {{ form.has_box }}
                                        <label class="form-check-label" for="{{ form.has_box.id_for_label }}">Box
                                            Included</label>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-check">
                                        {{ form.has_dust_bag }}
                                        <label class="form-check-label" for="{{ form.has_dust_bag.id_for_label }}">Dust
                                            Bag</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        {{ form.has_warranty_card }}
                                        <label class="form-check-label"
                                            for="{{ form.has_warranty_card.id_for_label }}">Warranty Card</label>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-check">
                                        {{ form.has_care_card }}
                                        <label class="form-check-label" for="{{ form.has_care_card.id_for_label }}">Care
                                            Card</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        {{ form.has_extras }}
                                        <label class="form-check-label" for="{{ form.has_extras.id_for_label }}">Extra
                                            Straps / Buttons / Links</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.packaging_condition.id_for_label }}" class="form-label">Packaging
                                Condition</label>
                            {{ form.packaging_condition }}
                        </div>
                        <div class="col-md-8">
                            <label for="{{ form.packaging_notes.id_for_label }}" class="form-label">Packaging
                                Notes</label>
                            {{ form.packaging_notes }}
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            {{ form.has_box }}{{ form.has_dust_bag }}{{ form.has_warranty_card }}{{ form.has_care_card }}{{
            form.has_extras }}{{ form.packaging_condition }}{{ form.packaging_notes }}
            {% endif %}

            
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">6. Compliance & Materials</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            {% if form.country_of_origin.is_hidden %}
                            {{ form.country_of_origin }}
                            {% else %}
                            <label for="{{ form.country_of_origin.id_for_label }}" class="form-label">Country of
                                Origin</label>
                            {{ form.country_of_origin }}
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.material.id_for_label }}" class="form-label">Main Materials</label>
                            {{ form.material }}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.material_composition.id_for_label }}" class="form-label">Material
                                Composition / Blend</label>
                            {{ form.material_composition }}
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">7. Media Upload</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-lg-6">
                            <label for="{{ form.image.id_for_label }}" class="form-label">Main Product Image <span
                                    class="text-danger">*</span></label>
                            {{ form.image }}
                            {{ form.image.errors }}
                            <small class="form-text text-muted">Required. Use clear, front-on shot.</small>
                            <div class="mt-3">
                                <img id="imagePreview" src="#" alt="Preview" style="max-height: 220px; display: none;"
                                    class="img-fluid rounded border">
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <label class="form-label">Additional Images</label>
                            <input type="file" name="additional_images" id="additionalImages" class="form-control"
                                accept="image/*" multiple>
                            <small class="form-text text-muted">Optional gallery (multiple).</small>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">8. Tags & Metadata</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="{{ form.internal_tags.id_for_label }}" class="form-label">Internal Tags</label>
                            {{ form.internal_tags }}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.keywords.id_for_label }}" class="form-label">Keywords for Search</label>
                            {{ form.keywords }}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.display_notes.id_for_label }}" class="form-label">Display Notes</label>
                            {{ form.display_notes }}
                            <small class="form-text text-muted">Where to place in-store.</small>
                        </div>
                        <div class="col-12">
                            {% if form.provenance_notes.is_hidden %}
                            {{ form.provenance_notes }}
                            {% else %}
                            <label for="{{ form.provenance_notes.id_for_label }}" class="form-label">Provenance /
                                Authentication Notes</label>
                            {{ form.provenance_notes }}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="d-flex justify-content-end gap-2 mb-5">
                <a href="{% url 'product_list' %}" class="btn btn-view">Cancel</a>
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-circle"></i> Register Product
                </button>
            </div>
        </form>
    </div>
</div>


<div id="emptyVariantForm" class="d-none">
    {% with variant_form=variant_formset.empty_form %}
    <div class="card mb-3 variant-entry" data-index="__prefix__">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <strong>Variant __number__</strong>
                <span class="text-muted small ms-2">SKU (auto if blank), retail, quantity required.</span>
            </div>
            <button type="button" class="btn btn-sm btn-delete remove-variant">Remove</button>
        </div>
        <div class="card-body">
            {{ variant_form.id }}{{ variant_form.DELETE.as_hidden }}
            <div class="row g-3 mb-2">
                <div class="col-md-4">
                    <label class="form-label">Variant SKU</label>
                    {{ variant_form.sku }}
                </div>
                <div class="col-md-4">
                    <label class="form-label">Color</label>
                    {{ variant_form.color }}
                </div>
                <div class="col-md-4">
                    <label class="form-label">Size</label>
                    {{ variant_form.size }}
                </div>
            </div>
            <div class="row g-3 mb-2">
                {% if not variant_form.cost_price.is_hidden %}
                <div class="col-md-3">
                    <label class="form-label">Cost Price</label>
                    {{ variant_form.cost_price }}
                </div>
                {% else %}
                {{ variant_form.cost_price }}
                {% endif %}
                <div class="col-md-3">
                    <label class="form-label">Retail Price <span class="text-danger">*</span></label>
                    {{ variant_form.retail_price }}
                </div>
                <div class="col-md-2">
                    <label class="form-label">Current Qty <span class="text-danger">*</span></label>
                    {{ variant_form.initial_quantity }}
                </div>
                <div class="col-md-2">
                    <label class="form-label">Currency</label>
                    {{ variant_form.currency }}
                </div>
            </div>
            {{ variant_form.minimum_stock_level }}{{ variant_form.currency }}{{ variant_form.barcode }}{{
            variant_form.barcode_type }}
        </div>
    </div>
    {% endwith %}
</div>

<script>
    // Image preview
    function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                const img = document.getElementById('imagePreview');
                img.src = e.target.result;
                img.style.display = 'inline-block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const brandField = document.getElementById('{{ form.brand.id_for_label }}');
        const categoryField = document.getElementById('{{ form.category.id_for_label }}');
        const skuField = document.getElementById('{{ form.base_sku.id_for_label }}');
        const imageInput = document.getElementById('{{ form.image.id_for_label }}');

        function generateSKU() {
            if (skuField.value) return;
            const brand = (brandField.value || '').toUpperCase().substring(0, 3);
            const category = (categoryField.value || '').toUpperCase().substring(0, 3);
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            if (brand && category) {
                skuField.value = `${brand}-${category}-${random}`;
            }
        }

        brandField.addEventListener('change', generateSKU);
        categoryField.addEventListener('change', generateSKU);
        if (imageInput) {
            imageInput.addEventListener('change', function () { previewImage(this); });
        }

        // Variant formset add/remove
        const addVariantBtn = document.getElementById('addVariantBtn');
        const variantFormset = document.getElementById('variantFormset');
        const totalForms = document.getElementById('id_variants-TOTAL_FORMS');
        const emptyVariantForm = document.getElementById('emptyVariantForm').innerHTML;

        function bindRemoveButtons() {
            document.querySelectorAll('.remove-variant').forEach(btn => {
                btn.onclick = function () {
                    const card = btn.closest('.variant-entry');
                    const deleteInput = card.querySelector('input[name$="-DELETE"]');
                    if (deleteInput) {
                        deleteInput.checked = true;
                    }
                    card.classList.add('d-none');
                }
            });
        }

        addVariantBtn.addEventListener('click', function () {
            const index = parseInt(totalForms.value);
            const newFormHtml = emptyVariantForm
                .replace(/__prefix__/g, index)
                .replace(/__number__/g, index + 1);
            const wrapper = document.createElement('div');
            wrapper.innerHTML = newFormHtml;
            variantFormset.appendChild(wrapper.firstElementChild);
            totalForms.value = index + 1;
            bindRemoveButtons();
        });

        bindRemoveButtons();
    });
</script>
{% endblock %}