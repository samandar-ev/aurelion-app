{% extends 'core/base.html' %}

{% block title %}{% if editing %}Edit{% else %}Create{% endif %} Promotion - AURELION{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">{% if editing %}Edit Promotion{% else %}New Promotion{% endif %}</h2>
        <p class="text-muted small mb-0">Configure discount rules and conditions</p>
    </div>
    <a href="{% url 'promotion_list' %}" class="btn btn-view">Cancel</a>
</div>

<form method="post" class="row g-4">
    {% csrf_token %}

    
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <strong>Basic Information</strong>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label">Promotion Name *</label>
                        <input type="text" name="name" class="form-control" value="{{ form.name.value|default:'' }}"
                            required placeholder="e.g. Holiday Sale 20% Off">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Promo Code</label>
                        <input type="text" name="code" class="form-control" value="{{ form.code.value|default:'' }}"
                            placeholder="HOLIDAY20">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="2"
                            placeholder="Optional description...">{{ form.description.value|default:'' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="card mb-4">
            <div class="card-header">
                <strong>Discount Type</strong>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Type *</label>
                        <select name="promo_type" class="form-select" id="promoType" onchange="toggleFields()">
                            <option value="PERCENTAGE">Percentage Off</option>
                            <option value="FIXED">Fixed Amount Off</option>
                            <option value="BOGO">Buy X Get Y Free</option>
                            <option value="TIERED">Tier-Based Discount</option>
                        </select>
                    </div>

                    
                    <div class="col-md-6" id="discountValueField">
                        <label class="form-label">Discount Value</label>
                        <div class="input-group">
                            <span class="input-group-text" id="discountSymbol">%</span>
                            <input type="number" name="discount_value" class="form-control" value="10" step="0.01"
                                min="0">
                        </div>
                    </div>

                    
                    <div class="col-md-3 bogo-field" style="display: none;">
                        <label class="form-label">Buy Quantity</label>
                        <input type="number" name="buy_quantity" class="form-control" value="2" min="1">
                    </div>
                    <div class="col-md-3 bogo-field" style="display: none;">
                        <label class="form-label">Get Free</label>
                        <input type="number" name="get_quantity" class="form-control" value="1" min="1">
                    </div>

                    
                    <div class="col-md-4 tiered-field" style="display: none;">
                        <label class="form-label">Silver Discount %</label>
                        <input type="number" name="silver_discount" class="form-control" value="5" step="0.01">
                    </div>
                    <div class="col-md-4 tiered-field" style="display: none;">
                        <label class="form-label">Gold Discount %</label>
                        <input type="number" name="gold_discount" class="form-control" value="10" step="0.01">
                    </div>
                    <div class="col-md-4 tiered-field" style="display: none;">
                        <label class="form-label">Platinum Discount %</label>
                        <input type="number" name="platinum_discount" class="form-control" value="15" step="0.01">
                    </div>
                </div>
            </div>
        </div>

        
        <div class="card mb-4">
            <div class="card-header">
                <strong>Applies To</strong>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Scope</label>
                        <select name="applies_to" class="form-select" id="appliesTo" onchange="toggleAppliesTo()">
                            <option value="ALL">All Products</option>
                            <option value="CATEGORY">Specific Category</option>
                            <option value="BRAND">Specific Brand</option>
                            <option value="PRODUCTS">Selected Products</option>
                        </select>
                    </div>
                    <div class="col-md-4" id="categoryField" style="display: none;">
                        <label class="form-label">Category</label>
                        <select name="category" class="form-select">
                            <option value="">Select category...</option>
                            <option value="Bags">Bags</option>
                            <option value="Shoes">Shoes</option>
                            <option value="Accessories">Accessories</option>
                            <option value="Clothing">Clothing</option>
                            <option value="Jewelry">Jewelry</option>
                            <option value="Watches">Watches</option>
                            <option value="Eyewear">Eyewear</option>
                            <option value="Fragrance">Fragrance</option>
                        </select>
                    </div>
                    <div class="col-md-4" id="brandField" style="display: none;">
                        <label class="form-label">Brand</label>
                        <input type="text" name="brand" class="form-control" value="" placeholder="e.g. Gucci">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Customer Tier</label>
                        <select name="customer_tier" class="form-select">
                            <option value="ALL">All Customers</option>
                            <option value="SILVER">Silver & Above</option>
                            <option value="GOLD">Gold & Above</option>
                            <option value="PLATINUM">Platinum Only</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="card mb-4">
            <div class="card-header">
                <strong>Conditions</strong>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Min Purchase ($)</label>
                        <input type="number" name="min_purchase" class="form-control" value="0" step="0.01" min="0">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Min Items</label>
                        <input type="number" name="min_items" class="form-control" value="0" min="0">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Max Uses (0=unlimited)</label>
                        <input type="number" name="max_uses" class="form-control" value="0" min="0">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Max Per Customer</label>
                        <input type="number" name="max_uses_per_customer" class="form-control" value="0" min="0">
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <strong>Status & Validity</strong>
            </div>
            <div class="card-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" name="is_active" id="isActive" checked>
                    <label class="form-check-label" for="isActive">Active</label>
                </div>

                <div class="mb-3">
                    <label class="form-label">Start Date *</label>
                    <input type="datetime-local" name="start_date" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">End Date *</label>
                    <input type="datetime-local" name="end_date" class="form-control" required>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg w-100">
            {% if editing %}Update Promotion{% else %}Create Promotion{% endif %}
        </button>
    </div>
</form>

<script>
    function toggleFields() {
        const type = document.getElementById('promoType').value;
        const discountField = document.getElementById('discountValueField');
        const discountSymbol = document.getElementById('discountSymbol');
        const bogoFields = document.querySelectorAll('.bogo-field');
        const tieredFields = document.querySelectorAll('.tiered-field');

        // Hide all
        bogoFields.forEach(f => f.style.display = 'none');
        tieredFields.forEach(f => f.style.display = 'none');
        discountField.style.display = 'block';

        if (type === 'PERCENTAGE') {
            discountSymbol.textContent = '%';
        } else if (type === 'FIXED') {
            discountSymbol.textContent = '$';
        } else if (type === 'BOGO') {
            discountField.style.display = 'none';
            bogoFields.forEach(f => f.style.display = 'block');
        } else if (type === 'TIERED') {
            discountField.style.display = 'none';
            tieredFields.forEach(f => f.style.display = 'block');
        }
    }

    function toggleAppliesTo() {
        const scope = document.getElementById('appliesTo').value;
        document.getElementById('categoryField').style.display = scope === 'CATEGORY' ? 'block' : 'none';
        document.getElementById('brandField').style.display = scope === 'BRAND' ? 'block' : 'none';
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function () {
        toggleFields();
        toggleAppliesTo();
    });
</script>
{% endblock %}