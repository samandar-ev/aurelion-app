{% extends 'core/base.html' %}

{% block title %}Barcode Generator - AURELION{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">Barcode Generator</h2>
        <p class="text-muted text-sm mb-0">Select items to generate printable barcodes</p>
    </div>
</div>


<div class="card mb-4">
    <div class="card-body py-3">
        <form method="get" class="d-flex gap-2">
            <div class="input-group" style="max-width: 400px;">
                <span class="input-group-text bg-transparent border-end-0">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                    </svg>
                </span>
                <input type="text" name="q" class="form-control border-start-0" 
                       placeholder="Search by product name, brand, or SKU..." 
                       value="{{ request.GET.q }}">
            </div>
            <button type="submit" class="btn btn-secondary">Search</button>
            {% if request.GET.q %}
            <a href="{% url 'barcode_generator' %}" class="btn btn-ghost">Clear</a>
            {% endif %}
        </form>
    </div>
</div>

<form method="post" action="{% url 'barcode_generate_pdf' %}" id="barcodeForm">
    {% csrf_token %}
    
    
    <div class="card mb-3">
        <div class="card-body py-3 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAll">
                    <label class="form-check-label text-sm" for="selectAll">Select All on Page</label>
                </div>
                <span class="text-muted text-sm" id="selectedCount">0 items selected</span>
            </div>
            <button type="button" class="btn btn-primary" id="generateBtn" disabled data-bs-toggle="modal" data-bs-target="#generateModal">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="me-1">
                    <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/>
                </svg>
                Generate Barcodes
            </button>
        </div>
    </div>

    
    <div class="card">
        <div class="table-responsive">
            <table class="table mb-0">
                <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th style="width: 50px;"></th>
                        <th>Product</th>
                        <th>Variant</th>
                        <th>SKU</th>
                        <th class="text-end">Price</th>
                        <th class="text-center">Stock</th>
                    </tr>
                </thead>
                <tbody>
                    {% for variant in variants %}
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input variant-checkbox" 
                                   name="variants" value="{{ variant.id }}" data-stock="{{ variant.initial_quantity }}">
                        </td>
                        <td>
                            {% if variant.product.image %}
                            <img src="{{ variant.product.image.url }}" alt="" 
                                 style="width: 36px; height: 36px; object-fit: cover; border-radius: 4px;">
                            {% else %}
                            <div style="width: 36px; height: 36px; background: var(--bg-tertiary); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                <span class="text-muted text-xs">‚Äî</span>
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            <p class="fw-semibold mb-0 text-sm">{{ variant.product.brand }}</p>
                            <p class="text-muted text-xs mb-0">{{ variant.product.name }}</p>
                        </td>
                        <td>
                            <span class="text-sm">{{ variant.color|default:"‚Äî" }} / {{ variant.size|default:"‚Äî" }}</span>
                        </td>
                        <td>
                            <code class="text-xs">{{ variant.sku }}</code>
                        </td>
                        <td class="text-end">
                            <span class="text-sm">${{ variant.retail_price }}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge {% if variant.initial_quantity < 5 %}bg-danger{% else %}bg-secondary{% endif %}">
                                {{ variant.initial_quantity }}
                            </span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <p class="empty-state-icon">üì¶</p>
                                <p class="empty-state-title">No products found</p>
                                <p class="empty-state-text">
                                    {% if request.GET.q %}
                                    Try a different search term
                                    {% else %}
                                    Add products to your inventory first
                                    {% endif %}
                                </p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</form>


<div class="modal fade" id="generateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Barcode Generation Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-sm text-muted mb-3">Choose how many barcodes to generate for each selected item:</p>
                
                <div class="mb-3">
                    <div class="form-check p-3 rounded" style="background: var(--bg-tertiary); cursor: pointer;" onclick="document.getElementById('modeSingle').checked = true;">
                        <input class="form-check-input" type="radio" name="barcodeMode" id="modeSingle" value="single" checked>
                        <label class="form-check-label w-100" for="modeSingle">
                            <strong>One barcode per item</strong>
                            <p class="text-xs text-muted mb-0 mt-1">Generate 1 barcode for each selected variant, regardless of stock quantity</p>
                        </label>
                    </div>
                </div>
                
                <div>
                    <div class="form-check p-3 rounded" style="background: var(--bg-tertiary); cursor: pointer;" onclick="document.getElementById('modeQuantity').checked = true;">
                        <input class="form-check-input" type="radio" name="barcodeMode" id="modeQuantity" value="quantity">
                        <label class="form-check-label w-100" for="modeQuantity">
                            <strong>One barcode per quantity in stock</strong>
                            <p class="text-xs text-muted mb-0 mt-1">Generate barcodes based on current stock level (e.g., 5 in stock = 5 barcodes)</p>
                        </label>
                    </div>
                </div>
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmGenerateBtn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="me-1">
                        <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/>
                    </svg>
                    Generate PDF
                </button>
            </div>
        </div>
    </div>
</div>


{% if page_obj and page_obj.paginator.num_pages > 1 %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">‚Üê Prev</a>
        </li>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">{{ num }}</a>
            </li>
            {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">Next ‚Üí</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.variant-checkbox');
    const selectedCount = document.getElementById('selectedCount');
    const generateBtn = document.getElementById('generateBtn');
    const barcodeForm = document.getElementById('barcodeForm');
    const confirmGenerateBtn = document.getElementById('confirmGenerateBtn');
    
    // Confirm generation
    confirmGenerateBtn.addEventListener('click', function() {
        const mode = document.querySelector('input[name="barcodeMode"]:checked').value;
        
        // Remove existing mode input if any
        const existingInput = barcodeForm.querySelector('input[name="barcode_mode"]');
        if (existingInput) {
            existingInput.remove();
        }
        
        // Create a new hidden input for the mode
        const modeInput = document.createElement('input');
        modeInput.type = 'hidden';
        modeInput.name = 'barcode_mode';
        modeInput.value = mode;
        barcodeForm.appendChild(modeInput);
        
        // Submit the form
        barcodeForm.submit();
    });
    
    function updateCount() {
        const checked = document.querySelectorAll('.variant-checkbox:checked').length;
        selectedCount.textContent = checked + ' item' + (checked !== 1 ? 's' : '') + ' selected';
        generateBtn.disabled = checked === 0;
    }
    
    selectAll.addEventListener('change', function() {
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateCount();
    });
    
    checkboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            selectAll.checked = document.querySelectorAll('.variant-checkbox:checked').length === checkboxes.length;
            updateCount();
        });
    });
});
</script>
{% endblock %}

