{% extends 'core/base.html' %}

{% block title %}Order #{{ order.order_code|default:order.id }} - AURELION{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">Order #{{ order.order_code|default:order.id }}</h2>
        <p class="text-muted small mb-0">
            {{ order.created_at|date:"F d, Y" }} at {{ order.created_at|time:"H:i" }}
        </p>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'dashboard' %}" class="btn btn-view">‚Üê Back</a>
        <button onclick="printReceipt()" class="btn btn-primary">Download Receipt</button>
    </div>
</div>

<div class="row g-4 mb-4">
    
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase small mb-3" style="letter-spacing: 0.5px;">Order Information</h6>
                
                <div class="row g-3">
                    <div class="col-6">
                        <p class="text-muted small mb-1">Order ID</p>
                        <p class="fw-semibold mb-0">#{{ order.order_code|default:order.id }}</p>
                    </div>
                    <div class="col-6">
                        <p class="text-muted small mb-1">Status</p>
                        <p class="mb-0">
                            {% if order.status == 'FULLY_RETURNED' %}
                            <span class="badge bg-secondary">Fully Returned</span>
                            {% elif order.status == 'PARTIALLY_RETURNED' %}
                            <span class="badge bg-warning text-dark">Partial Return</span>
                            {% elif order.status == 'COMPLETED' %}
                            <span class="badge bg-success">Completed</span>
                            {% elif order.status == 'REFUNDED' %}
                            <span class="badge bg-danger">Refunded</span>
                            {% else %}
                            <span class="badge bg-light text-dark border">{{ order.get_status_display }}</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-6">
                        <p class="text-muted small mb-1">Client</p>
                        <p class="fw-semibold mb-0">{{ order.client|default:"Walk-in Customer" }}</p>
                    </div>
                    <div class="col-6">
                        <p class="text-muted small mb-1">Cashier</p>
                        <p class="fw-semibold mb-0">{{ order.created_by.username }}</p>
                    </div>
                    <div class="col-6">
                        <p class="text-muted small mb-1">Date</p>
                        <p class="fw-semibold mb-0">{{ order.created_at|date:"M d, Y" }}</p>
                    </div>
                    <div class="col-6">
                        <p class="text-muted small mb-1">Time</p>
                        <p class="fw-semibold mb-0">{{ order.created_at|time:"H:i" }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase small mb-3" style="letter-spacing: 0.5px;">Payment Summary</h6>
                
                <div class="d-flex justify-content-between py-2">
                    <span class="text-muted">Subtotal</span>
                    <span>${{ order.total_amount|add:order.total_discount|floatformat:2 }}</span>
                </div>
                {% if order.total_discount > 0 %}
                <div class="d-flex justify-content-between py-2">
                    <span class="text-muted">Discount</span>
                    <span class="text-success">-${{ order.total_discount|floatformat:2 }}</span>
                </div>
                {% endif %}
                <div class="d-flex justify-content-between py-3 border-top mt-2">
                    <span class="fw-bold">Total</span>
                    <span class="fw-bold fs-4" style="color: var(--brand-primary);">${{ order.total_amount|floatformat:2 }}</span>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="card">
    <div class="card-header">
        <h6 class="mb-0">Order Items</h6>
    </div>
    <div class="table-responsive">
        <table class="table mb-0">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>SKU</th>
                    <th>Variant</th>
                    <th class="text-center">Qty</th>
                    <th class="text-center">Returned</th>
                    <th class="text-end">Unit Price</th>
                    <th class="text-end">Total</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr class="{% if item.is_fully_returned %}table-secondary{% elif item.qty_returned > 0 %}table-warning{% endif %}">
                    <td>
                        <div class="fw-semibold {% if item.is_fully_returned %}text-decoration-line-through text-muted{% endif %}">
                            {{ item.variant.product.brand }} {{ item.variant.product.name }}
                        </div>
                        {% if item.is_fully_returned %}
                        <span class="badge bg-secondary small">Returned</span>
                        {% elif item.qty_returned > 0 %}
                        <span class="badge bg-warning text-dark small">{{ item.qty_returned }} returned</span>
                        {% endif %}
                    </td>
                    <td class="{% if item.is_fully_returned %}text-muted{% endif %}">
                        <code class="small">{{ item.variant.sku }}</code>
                    </td>
                    <td class="{% if item.is_fully_returned %}text-muted{% endif %}">
                        {% if item.variant.color or item.variant.size %}
                        {{ item.variant.color|default:"-" }} / {{ item.variant.size|default:"-" }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td class="text-center {% if item.is_fully_returned %}text-muted{% endif %}">{{ item.quantity }}</td>
                    <td class="text-center">
                        {% if item.qty_returned > 0 %}
                        <span class="text-danger fw-semibold">{{ item.qty_returned }}</span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td class="text-end {% if item.is_fully_returned %}text-muted{% endif %}">${{ item.unit_price|floatformat:2 }}</td>
                    <td class="text-end {% if item.is_fully_returned %}text-muted{% endif %}">${{ item.line_total|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


{% if order.returns.exists %}
<div class="card mt-4">
    <div class="card-header">
        <h6 class="mb-0">Return History</h6>
    </div>
    <div class="table-responsive">
        <table class="table mb-0">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Action</th>
                    <th>Reason</th>
                    <th>Items Returned</th>
                    <th>Processed By</th>
                </tr>
            </thead>
            <tbody>
                {% for return in order.returns.all %}
                <tr>
                    <td>{{ return.created_at|date:"M d, Y H:i" }}</td>
                    <td>
                        {% if return.action == 'REFUND' %}
                        <span class="badge bg-danger">Refund</span>
                        {% else %}
                        <span class="badge bg-info">Exchange</span>
                        {% endif %}
                    </td>
                    <td>{{ return.get_reason_display }}</td>
                    <td>
                        {% for ri in return.items.all %}
                        {{ ri.quantity }}x {{ ri.order_item.variant.product.name }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    </td>
                    <td>{{ return.created_by.username }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<script>
    const ORDER_DATA = {{ order_data_json|safe }};

    function printReceipt() {
        const html = buildReceipt(ORDER_DATA);
        const printWindow = window.open('', 'PRINT', 'height=600,width=400');
        if (printWindow) {
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
            }, 250);
        } else {
            alert('Please allow popups to print the receipt.');
        }
    }

    function buildReceipt(data) {
        const now = new Date(data.created_at);
        const client = data.client || 'Walk-in';
        const cashier = data.cashier;
        const subtotal = parseFloat(data.subtotal);
        const discount = parseFloat(data.discount);
        const total = parseFloat(data.total);

        let itemsRows = '';
        data.items.forEach(item => {
            const variant = item.color || item.size ? `${item.color || ''} ${item.size || ''}`.trim() : '';
            itemsRows += `
        <tr>
            <td>
                <div style="font-weight: 500;">${item.name}</div>
                <div style="color: #777; font-size: 12px;">${item.sku}${variant ? ' | ' + variant : ''}</div>
            </td>
            <td style="text-align: center;">${item.qty}</td>
            <td style="text-align: right;">$${item.price.toFixed(2)}</td>
            <td style="text-align: right;">$${item.total.toFixed(2)}</td>
        </tr>`;
        });

        return `
    <html>
        <head>
            <style>
                body { font-family: 'Inter', -apple-system, sans-serif; padding: 24px; color: #111; max-width: 400px; margin: 0 auto; }
                h1 { letter-spacing: 2px; font-size: 24px; margin-bottom: 8px; text-align: center; }
                .header { text-align: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #C0A464; }
                .muted { color: #777; font-size: 13px; margin: 4px 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 16px; }
                th, td { padding: 10px 4px; border-bottom: 1px solid #eee; font-size: 13px; }
                th { text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #888; }
                .totals { margin-top: 16px; padding-top: 16px; border-top: 2px solid #eee; }
                .totals div { display: flex; justify-content: space-between; padding: 6px 0; font-size: 14px; }
                .totals .total-row { font-size: 18px; font-weight: 600; padding-top: 12px; border-top: 1px solid #eee; margin-top: 8px; }
                .accent { color: #C0A464; font-weight: 500; }
                .footer { text-align: center; margin-top: 24px; padding-top: 16px; border-top: 1px dashed #ddd; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>AURELION</h1>
                <div class="muted">Luxury Fashion & Accessories</div>
            </div>
            <div class="muted">Order: <strong>${data.order_code}</strong></div>
            <div class="muted">Client: ${client}</div>
            <div class="muted">Cashier: ${cashier}</div>
            <div class="muted">Date: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}</div>
            <table>
                <thead>
                    <tr>
                        <th>Item</th>
                        <th style="text-align: center;">Qty</th>
                        <th style="text-align: right;">Price</th>
                        <th style="text-align: right;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${itemsRows}
                </tbody>
            </table>
            <div class="totals">
                <div><span>Subtotal</span><span>$${subtotal.toFixed(2)}</span></div>
                ${discount > 0 ? `<div><span>Discount</span><span style="color: #34C759;">-$${discount.toFixed(2)}</span></div>` : ''}
                <div class="total-row"><span>Total</span><span class="accent">$${total.toFixed(2)}</span></div>
            </div>
            <div class="footer">
                <p class="accent" style="margin: 0;">Thank you for your purchase!</p>
                <p class="muted" style="font-size: 11px; margin-top: 8px;">This serves as your official receipt.</p>
            </div>
        </body>
    </html>`;
    }
</script>
{% endblock %}
