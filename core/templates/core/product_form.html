{% extends 'core/base.html' %}

{% block title %}{% if editing %}Edit Product{% else %}Quick Add Product{% endif %} - AURELION{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="d-flex align-items-center justify-content-between mb-4">
            <div class="d-flex align-items-center">
                <a href="{% url 'product_list' %}" class="text-decoration-none text-muted me-3">&larr; Back</a>
                <div>
                    <h2 class="mb-1">{% if editing %}Edit Product{% else %}Quick Add Product{% endif %}</h2>
                    <p class="text-muted small mb-0">Only the essentials up front, with optional details tucked away.
                    </p>
                </div>
            </div>
            <span class="badge bg-secondary">Owner</span>
        </div>

        <form method="post" enctype="multipart/form-data" id="quickProductForm" class="needs-validation" novalidate>
            {% csrf_token %}

            {% if form.non_field_errors %}
            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
            {% endif %}

            <datalist id="brand-options">
                {% for brand in brand_suggestions %}
                <option value="{{ brand }}"></option>
                {% endfor %}
            </datalist>

            
            <div class="card mb-3 border-0 shadow-sm">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="{{ form.brand.id_for_label }}" class="form-label">Brand <span
                                    class="text-danger">*</span></label>
                            {{ form.brand }}
                            {{ form.brand.errors }}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.name.id_for_label }}" class="form-label">Product Name <span
                                    class="text-danger">*</span></label>
                            {{ form.name }}
                            {{ form.name.errors }}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.category.id_for_label }}" class="form-label">Category <span
                                    class="text-danger">*</span></label>
                            {{ form.category }}
                            {{ form.category.errors }}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.base_sku.id_for_label }}" class="form-label">Base SKU <span
                                    class="text-danger">*</span></label>
                            {{ form.base_sku }}
                            {{ form.base_sku.errors }}
                        </div>
                        <div class="col-md-4 text-center">
                            <label class="form-label d-block">Main Image</label>
                            <label for="{{ form.image.id_for_label }}" class="btn btn-view btn-sm">
                                <i class="bi bi-camera"></i> Upload
                            </label>
                            <input type="file" name="{{ form.image.name }}" id="{{ form.image.id_for_label }}"
                                class="d-none" accept="image/*">
                            {{ form.image.errors }}
                            <div class="mt-2">
                                <img id="imagePreview" src="#" alt="Preview" style="max-height: 150px; display: none;"
                                    class="img-fluid rounded border">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if not editing %}
            
            <div class="card mb-3 border-0 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Color / Size Breakdown</h5>
                    <small class="text-muted">Quantities + pricing per variant</small>
                </div>
                <div class="card-body">
                    {% with quick_variant_rows as rows %}
                    <input type="hidden" id="id_quick_variants-TOTAL_FORMS" name="quick_variants-TOTAL_FORMS"
                        value="{% if rows %}{{ rows|length }}{% else %}1{% endif %}">
                    <div id="quickVariantRows" class="row g-3">
                        {% if rows %}
                        {% for row in rows %}
                        <div class="col-12 quick-variant-row" data-index="{{ forloop.counter0 }}">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-2">
                                    <label class="form-label">Color</label>
                                    <input type="text" name="quick_variants-{{ forloop.counter0 }}-color"
                                        value="{{ row.color }}" class="form-control" placeholder="Black">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Size</label>
                                    <input type="text" name="quick_variants-{{ forloop.counter0 }}-size"
                                        value="{{ row.size }}" class="form-control" placeholder="One Size">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Qty <span class="text-danger">*</span></label>
                                    <input type="number" name="quick_variants-{{ forloop.counter0 }}-quantity"
                                        value="{{ row.quantity }}" class="form-control" min="1" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Cost <span class="text-danger">*</span></label>
                                    <input type="number" step="0.01" min="0"
                                        name="quick_variants-{{ forloop.counter0 }}-cost_price"
                                        value="{{ row.cost_price }}" class="form-control" required placeholder="0.00">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Retail <span class="text-danger">*</span></label>
                                    <input type="number" step="0.01" min="0"
                                        name="quick_variants-{{ forloop.counter0 }}-retail_price"
                                        value="{{ row.retail_price }}" class="form-control" required placeholder="0.00">
                                </div>
                                <div class="col-md-2 d-flex">
                                    <button type="button" class="btn btn-outline-secondary w-100 remove-variant-row" {% if forloop.counter0 == 0 %}disabled{% endif %}>Remove</button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="col-12 quick-variant-row" data-index="0">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-2">
                                    <label class="form-label">Color</label>
                                    <input type="text" name="quick_variants-0-color" class="form-control"
                                        placeholder="Black">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Size</label>
                                    <input type="text" name="quick_variants-0-size" class="form-control"
                                        placeholder="One Size">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Qty <span class="text-danger">*</span></label>
                                    <input type="number" name="quick_variants-0-quantity" class="form-control" min="1"
                                        required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Cost <span class="text-danger">*</span></label>
                                    <input type="number" step="0.01" min="0" name="quick_variants-0-cost_price"
                                        class="form-control" required placeholder="0.00">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Retail <span class="text-danger">*</span></label>
                                    <input type="number" step="0.01" min="0" name="quick_variants-0-retail_price"
                                        class="form-control" required placeholder="0.00">
                                </div>
                                <div class="col-md-2 d-flex">
                                    <button type="button" class="btn btn-delete w-100 remove-variant-row"
                                        disabled>Remove</button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endwith %}
                    <button type="button" class="btn btn-view mt-3" id="addQuickVariant">
                        + Add another color/size
                    </button>
                </div>
            </div>
            {% endif %}

            
            <div class="accordion mb-3" id="optionalDetails">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOptional">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseOptional">
                            Optional Details (collection, season, material, limited edition)
                        </button>
                    </h2>
                    <div id="collapseOptional" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="{{ form.collection.id_for_label }}"
                                        class="form-label">Collection</label>
                                    {{ form.collection }}
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.season.id_for_label }}" class="form-label">Season</label>
                                    {{ form.season }}
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <div class="form-check">
                                        {{ form.is_limited_edition }}
                                        <label class="form-check-label"
                                            for="{{ form.is_limited_edition.id_for_label }}">Limited Edition</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.material.id_for_label }}" class="form-label">Material</label>
                                    {{ form.material }}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.material_composition.id_for_label }}"
                                        class="form-label">Composition / Details</label>
                                    {{ form.material_composition }}
                                </div>
                                <div class="col-12">
                                    <label for="{{ form.description.id_for_label }}"
                                        class="form-label">Description</label>
                                    {{ form.description }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-2 mb-5">
                <a href="{% url 'product_list' %}" class="btn btn-view">Cancel</a>
                <button type="submit" class="btn btn-primary">
                    {% if editing %}Save Changes{% else %}Save Quick Add{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<template id="quickVariantTemplate">
    <div class="col-12 quick-variant-row" data-index="__index__">
        <div class="row g-2 align-items-end">
            <div class="col-md-2">
                <label class="form-label">Color</label>
                <input type="text" name="quick_variants-__index__-color" class="form-control"
                    placeholder="Black">
            </div>
            <div class="col-md-2">
                <label class="form-label">Size</label>
                <input type="text" name="quick_variants-__index__-size" class="form-control"
                    placeholder="One Size">
            </div>
            <div class="col-md-2">
                <label class="form-label">Qty <span class="text-danger">*</span></label>
                <input type="number" name="quick_variants-__index__-quantity" class="form-control" min="1" required>
            </div>
            <div class="col-md-2">
                <label class="form-label">Cost <span class="text-danger">*</span></label>
                <input type="number" step="0.01" min="0" name="quick_variants-__index__-cost_price"
                    class="form-control" required placeholder="0.00">
            </div>
            <div class="col-md-2">
                <label class="form-label">Retail <span class="text-danger">*</span></label>
                <input type="number" step="0.01" min="0" name="quick_variants-__index__-retail_price"
                    class="form-control" required placeholder="0.00">
            </div>
            <div class="col-md-2 d-flex">
                <button type="button" class="btn btn-delete w-100 remove-variant-row">Remove</button>
            </div>
        </div>
    </div>
</template>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const addVariantBtn = document.getElementById('addQuickVariant');
        const rowsContainer = document.getElementById('quickVariantRows');
        const totalFormsInput = document.getElementById('id_quick_variants-TOTAL_FORMS');
        const template = document.getElementById('quickVariantTemplate');
        const imageInput = document.getElementById('{{ form.image.id_for_label }}');

        function updateRemoveButtons() {
            const buttons = rowsContainer?.querySelectorAll('.remove-variant-row') || [];
            buttons.forEach((btn, idx) => {
                btn.disabled = idx === 0;
                btn.onclick = function () {
                    const row = btn.closest('.quick-variant-row');
                    row.remove();
                    const count = rowsContainer.querySelectorAll('.quick-variant-row').length;
                    totalFormsInput.value = count;
                    updateRemoveButtons();
                }
            });
        }

        if (addVariantBtn) {
            addVariantBtn.onclick = function () {
                const newIndex = rowsContainer.querySelectorAll('.quick-variant-row').length;
                const html = template.innerHTML.replace(/__index__/g, newIndex);
                const wrapper = document.createElement('div');
                wrapper.innerHTML = html.trim();
                rowsContainer.appendChild(wrapper.firstElementChild);
                totalFormsInput.value = newIndex + 1;
                updateRemoveButtons();
            };
        }

        updateRemoveButtons();

        if (imageInput) {
            imageInput.addEventListener('change', function () { previewImage(this); });
        }
    });

    function previewImage(input) {
        if (input && input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                const img = document.getElementById('imagePreview');
                if (img) {
                    img.src = e.target.result;
                    img.style.display = 'inline-block';
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
</script>
{% endblock %}